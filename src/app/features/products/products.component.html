<div class="p-8 bg-gray-50 min-h-screen">
	<h2 class="text-3xl font-semibold text-gray-800 mb-4">Products Management</h2>

	<div *ngIf="successMessage" class="mb-3 p-3 rounded bg-green-50 text-green-700 border border-green-200">{{
		successMessage }}</div>
	<div *ngIf="errorMessage" class="mb-3 p-3 rounded bg-red-50 text-red-700 border border-red-200">{{ errorMessage }}
	</div>

	<div>
		<div class="flex justify-end mb-4">
			<button (click)="openCreatePopup()" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">
				Create Product
			</button>
		</div>
	</div>
	<div class="search-container mb-4">
		<input type="text" name="search_products" placeholder="Search products..." [(ngModel)]="searchTerm">
		<button (click)="searchProducts()">search</button>
		<button class="cancel" (click)="getProducts()">cancel</button>
	</div>
	<!-- Products Table -->
	<div class="overflow-x-auto">
		<table class="min-w-full bg-white rounded shadow-md">
			<thead class="bg-gray-100 text-left text-sm font-semibold text-gray-600">
				<tr>
					<th class="py-3 px-6">Image</th>
					<th class="py-3 px-6">Name</th>
					<th class="py-3 px-6">Price</th>
					<th class="py-3 px-6">Stock</th>
					<th class="py-3 px-6">Active</th>
					<th class="py-3 px-6">Category</th>
					<th class="py-3 px-6">Actions</th>
				</tr>
			</thead>
			<tbody class="text-gray-700 text-sm divide-y divide-gray-200">
				<tr class="hover:bg-gray-50" *ngFor="let product of paginatedProducts">
					<td class="py-3 px-6">
						<img [src]="product.imageUrls?.[0]" alt="Product Image"
							class="h-12 w-12 object-cover cursor-pointer rounded"
							(click)="openImagePopup(product.imageUrls?.[0])" />
					</td>
					<td class="py-3 px-6">{{ product.name }}</td>
					<td class="py-3 px-6">{{ product.price }}</td>
					<td class="py-3 px-6">
						<div class="flex items-center gap-2">
							<input type="number" min="0" class="w-20 border rounded px-2 py-1"
								[(ngModel)]="product.stock" [ngModelOptions]="{standalone: true}" />
							<button class="text-blue-600 hover:underline" (click)="saveStock(product)">Save</button>
						</div>
					</td>
					<td class="py-3 px-6">
						<label class="inline-flex items-center cursor-pointer">
							<input type="checkbox" class="sr-only peer" [(ngModel)]="product.isActive"
								[ngModelOptions]="{standalone: true}" (change)="saveActive(product)" />
							<div
								class="w-10 h-5 bg-gray-200 rounded-full peer-checked:bg-green-500 relative transition">
								<div
									class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-5">
								</div>
							</div>
						</label>
					</td>
					<td class="py-3 px-6">{{ product.category?.name || '—' }}</td>
					<td class="py-3 px-6 space-x-2">
						<button class="text-blue-600 hover:underline" (click)="openEditPopup(product)">Edit</button>
						<button class="text-red-600 hover:underline" (click)="deleteProduct(product)">Delete</button>
					</td>
				</tr>
			</tbody>
		</table>
	</div>
	<app-pagination [currentPage]="currentPage" [itemsPerPage]="itemsPerPage" [totalItems]="products.length"
		(pageChange)="onPageChange($event)">
	</app-pagination>
</div>

<!-- Image Popup -->
<div *ngIf="popupImageUrl" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50"
	(click)="closeImagePopup()">
	<div class="relative max-w-3xl max-h-[90vh] p-4 bg-white rounded shadow-lg">
		<img [src]="popupImageUrl" alt="Zoomed Image" class="max-w-full max-h-[80vh] mx-auto" />
		<button (click)="closeImagePopup()"
			class="absolute top-2 right-2 bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-800">✕</button>
	</div>
</div>
<div *ngIf="openCreateModal"
	class="fixed inset-0 z-50 bg-black bg-opacity-40 flex justify-center items-start pt-10 pb-10 overflow-auto">
	<div class="create-product-popup bg-white rounded-xl shadow-xl w-full max-w-2xl mx-4 p-6">
		<h2 class="popup-title mb-6 text-2xl font-bold text-gray-800 text-center">Create New Product</h2>

		<form [formGroup]="productForm" (ngSubmit)="submitProduct()" enctype="multipart/form-data"
			class="form space-y-6">

			<!-- Category Section -->
			<div class="form-section">
				<h3 class="section-title text-lg font-semibold text-gray-700 mb-3 border-b pb-2">Category Information
				</h3>

				<div class="space-y-4">
					<!-- Category -->
					<div>
						<div class="flex justify-between items-center mb-1">
							<label class="label">Category</label>
						</div>
						<select formControlName="categoryId" class="input-select">
							<option value="" selected>Select a category</option>
							<option *ngFor="let cat of categories" [value]="cat._id">{{ cat.name }}</option>
						</select>
						<p class="text-xs text-gray-500 mt-1">Can't find it? Type and we'll create it.</p>
						<input type="text" [(ngModel)]="newCategoryName" [ngModelOptions]="{standalone: true}"
							placeholder="New category name" class="input-text mt-2" />
					</div>

					<!-- Subcategory -->
					<div>
						<label class="label">Subcategory</label>
						<select formControlName="subcategoryId" class="input-select">
							<option value="" selected>Select a subcategory</option>
							<option *ngFor="let sub of subcategories" [value]="sub._id">{{ sub.name }}</option>
						</select>
						<p class="text-xs text-gray-500 mt-1">Optional. Type to create a new one under the selected
							category.</p>
						<input type="text" [(ngModel)]="newSubcategoryName" [ngModelOptions]="{standalone: true}"
							placeholder="New subcategory name" class="input-text mt-2" />
					</div>
				</div>
			</div>

			<!-- Product Details Section -->
			<div class="form-section">
				<h3 class="section-title text-lg font-semibold text-gray-700 mb-3 border-b pb-2">Product Details</h3>

				<div class="space-y-4">
					<!-- Name & Brand -->
					<div class="two-columns gap-4">
						<div>
							<label class="label">Product Name*</label>
							<input type="text" formControlName="name" placeholder="Enter product name"
								class="input-text" required />
							<div *ngIf="productForm.get('name')?.invalid && productForm.get('name')?.touched"
								class="text-red-500 text-sm mt-1">
								Product name is required
							</div>
						</div>
						<div>
							<label class="label">Brand*</label>
							<input type="text" formControlName="brand" placeholder="Enter brand name" class="input-text"
								required />
							<div *ngIf="productForm.get('brand')?.invalid && productForm.get('brand')?.touched"
								class="text-red-500 text-sm mt-1">
								Brand is required
							</div>
						</div>
					</div>

					<!-- SKU & Color -->
					<div class="two-columns gap-4">
						<div>
							<label class="label">SKU*</label>
							<input type="text" formControlName="sku" placeholder="Enter product SKU" class="input-text"
								required />
							<div *ngIf="productForm.get('sku')?.invalid && productForm.get('sku')?.touched"
								class="text-red-500 text-sm mt-1">
								SKU is required
							</div>
						</div>
						<div>
							<label class="label">Color Options</label>
							<input type="text" formControlName="color" placeholder="e.g. Red, Blue, Green"
								class="input-text" />
							<p class="text-xs text-gray-500 mt-1">Separate multiple colors with commas</p>
						</div>
					</div>

					<!-- Sizes & Material -->
					<div class="two-columns gap-4">
						<div>
							<label class="label">Available Sizes</label>
							<input type="text" formControlName="sizes" placeholder="e.g. S, M, L, XL"
								class="input-text" />
							<p class="text-xs text-gray-500 mt-1">Separate sizes with commas</p>
						</div>
						<div>
							<label class="label">Material</label>
							<input type="text" formControlName="material" placeholder="e.g. Cotton, Polyester"
								class="input-text" />
						</div>
					</div>

					<!-- Occasion & Gender -->
					<div class="two-columns gap-4">
						<div>
							<label class="label">Occasion</label>
							<input type="text" formControlName="occasion" placeholder="e.g. Casual, Formal"
								class="input-text" />
						</div>
						<div>
							<label class="label">Gender</label>
							<select formControlName="gender" class="input-select">
								<option value="" disabled selected>Select target gender</option>
								<option value="male">Male</option>
								<option value="female">Female</option>
								<option value="unisex">Unisex</option>
							</select>
						</div>
					</div>

					<!-- Care Instructions -->
					<div>
						<label class="label">Care Instructions</label>
						<textarea formControlName="careInstructions" placeholder="Enter care instructions..." rows="3"
							class="input-textarea"></textarea>
					</div>

					<!-- Tags -->
					<div>
						<label class="label">Product Tags</label>
						<input type="text" formControlName="tags" placeholder="e.g. summer, fashion, new-arrival"
							class="input-text" />
						<p class="text-xs text-gray-500 mt-1">Separate tags with commas for better discoverability</p>
					</div>
				</div>
			</div>

			<!-- Pricing & Inventory -->
			<div class="form-section">
				<h3 class="section-title text-lg font-semibold text-gray-700 mb-3 border-b pb-2">Pricing & Inventory
				</h3>

				<div class="two-columns gap-4">
					<div>
						<label class="label">Price*</label>
						<div class="relative">
							<span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">$</span>
							<input type="number" formControlName="price" placeholder="0.00" min="0" step="0.01"
								class="input-text pl-7" required />
						</div>
						<div *ngIf="productForm.get('price')?.invalid && productForm.get('price')?.touched"
							class="text-red-500 text-sm mt-1">
							Valid price is required
						</div>
					</div>
					<div>
						<label class="label">Stock Quantity*</label>
						<input type="number" formControlName="stock" min="0" placeholder="Available units"
							class="input-text" required />
						<div *ngIf="productForm.get('stock')?.invalid && productForm.get('stock')?.touched"
							class="text-red-500 text-sm mt-1">
							Stock quantity is required
						</div>
					</div>
				</div>
			</div>

			<!-- Images Section -->
			<div class="form-section">
				<h3 class="section-title text-lg font-semibold text-gray-700 mb-3 border-b pb-2">Product Images</h3>

				<div class="mb-3">
					<label class="label">Existing Image URLs (comma-separated)</label>
					<input type="text" [(ngModel)]="existingImageUrls" [ngModelOptions]="{standalone: true}"
						class="input-text" placeholder="https://... , https://..." />
				</div>

				<div>
					<label class="label">Upload Images*</label>
					<div
						class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-dashed border-orange-200 rounded-lg">
						<div class="space-y-1 text-center">
							<svg class="mx-auto h-12 w-12 text-orange-400" stroke="currentColor" fill="none"
								viewBox="0 0 48 48" aria-hidden="true">
								<path
									d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
									stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
							</svg>
							<div class="flex text-sm text-gray-600">
								<label for="file-upload"
									class="relative cursor-pointer bg-orange-50 rounded-md font-medium text-orange-600 hover:text-orange-500 focus-within:outline-none">
									<span>Upload files</span>
									<input id="file-upload" type="file" (change)="onImageSelected($event)" multiple
										class="file-input sr-only" />
								</label>
								<p class="pl-1">or drag and drop</p>
							</div>
							<p class="text-xs text-gray-500">PNG, JPG up to 5MB</p>
						</div>
					</div>
				</div>

				<!-- Preview Selected Images -->
				<div *ngIf="selectedImages.length > 0" class="mt-4">
					<label class="label">Selected Images</label>
					<div class="image-preview flex flex-wrap gap-2 mt-2">
						<div *ngFor="let file of selectedImages"
							class="image-preview-item flex items-center bg-orange-50 rounded-lg px-3 py-2">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-orange-500" fill="none"
								viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
							</svg>
							<span class="text-sm text-gray-700 truncate max-w-xs">{{ file.name }}</span>
							<button type="button" (click)="removeImage(file)"
								class="ml-2 text-orange-500 hover:text-orange-700">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
									stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M6 18L18 6M6 6l12 12" />
								</svg>
							</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Status Toggle -->
			<div class="flex items-center justify-between mt-6 p-4 bg-gray-50 rounded-lg">
				<div class="flex items-center">
					<input type="checkbox" formControlName="isActive" id="isActive" class="checkbox" />
					<label for="isActive" class="ml-2 block text-sm font-medium text-gray-700 cursor-pointer">
						Publish this product immediately
					</label>
				</div>
				<span class="text-xs text-gray-500">(Product will be visible to customers)</span>
			</div>

			<!-- Form Actions -->
			<div class="actions flex justify-end gap-4 pt-6 border-t border-gray-200">
				<button type="button" (click)="closeCreatePopup()" class="btn-cancel px-6 py-2">
					Cancel
				</button>
				<button type="submit" [disabled]="productForm.invalid || selectedImages.length === 0"
					class="btn-submit px-6 py-2 flex items-center">
					<span>Create Product</span>
					<svg *ngIf="isSubmitting" class="animate-spin -mr-1 ml-2 h-4 w-4 text-white"
						xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
						<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
						</circle>
						<path class="opacity-75" fill="currentColor"
							d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
						</path>
					</svg>
				</button>
			</div>
		</form>
	</div>
</div>